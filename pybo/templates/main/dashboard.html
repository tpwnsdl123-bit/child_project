{% extends "base.html" %}

{% block body_class %}hero-page{% endblock %}

{% block content %}

<section class="hero-section hero-dashboard">
    <div class="hero-overlay"></div>
    <div class="container hero-inner">
        <h1 class="hero-title">통계 대시보드</h1>
    </div>
</section>

<div class="container mt-4 mb-5">

    <div class="dashboard-filters d-flex flex-wrap align-items-end mb-4">
        <!-- 자치구 선택 - 검색형 인풋 -->
        <div class="me-3 mb-2">
            <label class="form-label mb-1 small text-muted">지역</label>
            <div class="position-relative d-flex align-items-center" style="max-width: 260px;">
                <input
                    type="text"
                    id="dashboard-gu-input"
                    class="form-control form-control-sm"
                    placeholder="지역 검색 (예: 서울시)"
                    value="서울시 전체"
                />

                <!-- 드롭다운 리스트 -->
                <div id="dashboard-gu-list" class="autocomplete-list"></div>
            </div>
        </div>

        <!-- 연도 범위 선택 -->
        <div class="me-3 mb-2">
            <label class="form-label mb-1 small text-muted">기간</label>
            <div class="d-flex align-items-center">
                <select
                    id="dashboard-year-start"
                    class="form-select form-select-sm dashboard-select"
                    style="max-width: 120px;"
                >
                    <option value="">전체</option>
                    {% for y in range(2015, 2023) %}
                    <option value="{{ y }}" {% if y == 2015 %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <span class="mx-2">~</span>
                <select
                    id="dashboard-year-end"
                    class="form-select form-select-sm dashboard-select"
                    style="max-width: 120px;"
                >
                    <option value="">전체</option>
                    {% for y in range(2015, 2023) %}
                    <option value="{{ y }}" {% if y == 2022 %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- 조회 버튼 -->
        <div class="mb-2">
            <button type="button" id="dashboard-refresh" class="filter-submit">조회하기</button>
        </div>
    </div>

    <!-- 지역아동센터 이용자 수 / 시설 수 패널 -->
    <div class="stat-panel p-4">
        <div class="d-flex justify-content-between align-items-baseline mb-3">
            <h4 class="mb-0">지역아동센터 이용자 수 / 시설 수</h4>
        </div>

        <p class="text-muted small mb-4">
            선택한 <strong>지역</strong>과 <strong>연도 범위</strong>에 따라
            지역아동센터 <strong>이용자 수</strong>와 <strong>시설 수</strong>를 집계합니다.<br>
            <span class="text-muted">
                <strong>2015~2022년</strong> 데이터는 실제 집계값입니다.<br>
            </span>
        </p>

        <!-- 여기 추가 -->
        <p id="dashboard-summary" class="text-muted small mb-3"></p>

        <!-- 표 자리만 남김 -->
        <div id="dashboard-table" class="stat-placeholder table-responsive">
            데이터를 불러오는 중입니다...
        </div>
    </div>

</div>
{% endblock %}

{% block script %}
<script>
    $(function () {
        console.log("dashboard script loaded");
        let ALL_DISTRICTS = [];

        // 페이지 로드 시, 종료 연도 셀렉트의 전체 연도 목록을 한 번 저장
        const ALL_YEARS = $('#dashboard-year-end option')
            .map(function () {
                return $(this).val();
            })
            .get()
            .filter(v => v)          // "" (전체) 제거
            .map(v => Number(v));    // 숫자로 변환

        // 시작연도에 따라 "종료연도" 옵션을 재구성 (작은 연도는 선택지에서 제거)
        function updateEndYearOptions() {
            const startVal = $('#dashboard-year-start').val();
            const startYear = startVal ? Number(startVal) : null;
            const $end = $('#dashboard-year-end');
            const prevEndVal = $end.val(); // 이전에 선택돼 있던 값

            // 종료연도 셀렉트 비우고 다시 채운다
            $end.empty();

            // "전체" 옵션은 항상 맨 위에 유지
            $end.append('<option value="">전체</option>');

            // 시작연도 이상인 연도만 옵션으로 추가
            ALL_YEARS.forEach(y => {
                if (!startYear || y >= startYear) {
                    $end.append(`<option value="${y}">${y}</option>`);
                }
            });

            // 이전에 선택했던 종료연도가 여전히 유효하면 그대로 유지
            if (prevEndVal && (!startYear || Number(prevEndVal) >= startYear)) {
                $end.val(prevEndVal);}
            else {
                // 아니면 "전체"로 리셋
                $end.val('');}
        }

        // 표 렌더링
        function renderDashboardTable(items) {
            const $placeholder = $('#dashboard-table');

            // 2015~2022년 데이터만 사용
            const filtered = (items || []).filter(row => {
                const y = Number(row.year);
                return y >= 2015 && y <= 2022;
            });

            if (!filtered.length) {
                $placeholder.html(
                    '<p class="text-muted small mb-0">해당 조건에 대한 2015~2022년 데이터가 없습니다.</p>'
                );
                return;
            }

            let html = `
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>연도</th>
                            <th>이용자 수</th>
                            <th>시설 수</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filtered.forEach(row => {
                html += `
                    <tr>
                        <td>${row.year}</td>
                        <td>${row.child_user}</td>
                        <td>${row.child_facility}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            $placeholder.html(html);
        }

        // 대시보드 데이터 로드
        function loadDashboardData() {
            const guInputRaw = $('#dashboard-gu-input').val().trim();
            const guInput = guInputRaw || '';  // null 방지

            let districtParam = '전체';   // 서버로 보낼 값
            let displayGu = '서울시';    // 화면에 보여줄 값

            // 공백 제거 + 소문자
            const norm = guInput.toLowerCase().replace(/\s/g, '');

            // '서울', '서울시', '서울시전체', '전체' -> 전부 "전체" 취급
            const isWholeSeoul =
                !guInput ||
                norm === '서울' ||
                norm === '서울시' ||
                norm === '서울시전체' ||
                norm === '전체';

            if (!isWholeSeoul) {
                // 실제 구 선택된 경우
                districtParam = guInput;
                displayGu = guInput;
            }

            const startYear = $('#dashboard-year-start').val();
            const endYear = $('#dashboard-year-end').val();

            if (startYear && endYear && Number(startYear) > Number(endYear)) {
                alert('시작 연도는 종료 연도보다 작거나 같아야 합니다.');
                return;
            }

            const params = new URLSearchParams({ district: districtParam });
            if (startYear) params.append('start_year', startYear);
            if (endYear) params.append('end_year', endYear);

            fetch('/data/dashboard-data?' + params.toString())
                .then(res => {
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log("/data/dashboard-data response:", data);

                    // 요약 문구
                    let summary = displayGu + ', ';
                    if (startYear && endYear) {
                        summary += `${startYear}년 ~ ${endYear}년 값입니다.`;
                    } else if (startYear && !endYear) {
                        summary += `${startYear}년 이후 값입니다.`;
                    } else if (!startYear && endYear) {
                        summary += `${endYear}년까지의 값입니다.`;
                    } else {
                        summary += '전체 기간 값입니다.';
                    }
                    $('#dashboard-summary').text(summary);

                    if (data.success) {
                        renderDashboardTable(data.items);
                    } else {
                        alert('데이터 로드 실패: ' + (data.error || '알 수 없는 오류'));
                    }
                })
                .catch(err => {
                    console.error("dashboard load error:", err);
                    alert('대시보드 데이터를 불러오는 중 오류가 발생했습니다.');
                });
        }

        // 자치구 목록 로드
        function loadDistricts() {
            fetch('/data/districts')
                .then(res => {
                    if (!res.ok) {
                        throw new Error('HTTP ' + res.status);}
                    return res.json();})
                .then(data => {
                    console.log("/data/districts response:", data);
                    if (!data.success) return;

                    ALL_DISTRICTS = data.districts || [];

                    const $list = $('#dashboard-gu-list');
                    $list.empty();

                    // "서울시 전체"는 따로 지원
                    $list.append('<div class="autocomplete-item" data-value="전체">서울시</div>');

                    ALL_DISTRICTS.forEach(d => {
                        $list.append(`<div class="autocomplete-item" data-value="${d}">${d}</div>`);
                    });

                    // 기본 조회
                    loadDashboardData();
                })
                .catch(err => {
                    console.error("loadDistricts error:", err);});
        }

        // 지역 자동완성: 인풋 포커스 / 입력 시 리스트 표시 & 필터링
        const $guInput = $('#dashboard-gu-input');
        const $guList = $('#dashboard-gu-list');

        // 리스트 보이기
        function showGuList() {
            $guList.show();
        }

        // 리스트 숨기기
        function hideGuList() {
            // 살짝 딜레이 줘서 클릭 선택 가능하게
            setTimeout(() => $guList.hide(), 150);
        }

        // 인풋 포커스 / 클릭 시 전체 리스트 보여주기
        $guInput.on('focus click', function () {
            // 필터 초기화
            $guList.find('.autocomplete-item').show();
            showGuList();
        });

        // 인풋에 타이핑할 때 필터링
        $guInput.on('input', function () {
            const keywordRaw = $(this).val().trim().toLowerCase();
            const keyword = keywordRaw.replace(/\s/g, '');   // 공백 제거

            $guList.find('.autocomplete-item').each(function () {
                const textRaw = $(this).text().toLowerCase();
                const text = textRaw.replace(/\s/g, '');     // 공백 제거

                if (!keyword || text.indexOf(keyword) !== -1) {
                    $(this).show();}
                else {
                    $(this).hide();}
            });

            showGuList();
        });

        // 리스트 항목 클릭 시 입력값 채우고 리스트 숨김
        $guList.on('mousedown', '.autocomplete-item', function () {
            const value = $(this).data('value');
            const text = $(this).text();
            $guInput.val(value === '전체' ? '서울시 전체' : text);
            hideGuList();
        });

        // 인풋에서 포커스 빠지면 리스트 숨김
        $guInput.on('blur', hideGuList);

        // 시작연도 바뀔 때마다 종료연도 옵션 재구성
        $('#dashboard-year-start').on('change', updateEndYearOptions);

        // 조회 버튼 클릭 시
        $('#dashboard-refresh').on('click', loadDashboardData);

        // 초기 실행
        loadDistricts();
    });
</script>
{% endblock %}
